<!DOCTYPE html>
<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta charset="UTF-8">
    <title>Mining RNG Simulator</title>
    <style>
        body {
            margin: 0;
            background: #111;
            color: white;
            font-family: Arial;
            display: flex;
            flex-direction: column;
            align-items: center;
			overflow-x: hidden;
        }

        #game {
    background: #222;
    cursor: pointer;
    margin-top: 10px;
    margin-left: -100px; /* move 20px to the left */
    position: relative;
    z-index: 1;
}


        /* UI below the canvas */
        #ui {
            display: flex;
            width: 1280px;
            margin-top: 10px;
        }
		.event-box {
    position: fixed;
    top: 150px;         
    left: 100px;
    padding: 8px 18px;
    background: rgba(0,0,0,0.85);
    color: white;
	font-family: Arial, sans-serif 
	font-weight: normal; /* or 100 for very thin */
    border: 2px solid white;
    border-radius: 8px;
    font-size: 20px;
    text-align: center;
    width: fit-content;
    z-index: 999;
}

        #pickaxeUI, #gearUI, #artefactUI, #luckArtefactUI {
            width: 320px;
            padding: 10px;
            background: #181818;
            overflow-y: auto;
            height: 250px;
            margin-right: 10px;
            border-radius: 8px;
        }

        #inventory {
            width: 960px;
            padding: 10px;
            background: #181818;
            overflow-y: auto;
            height: 150px;
            margin-top: 10px;
            border-radius: 8px;
        }

        /* Buttons styling */
        button {
            width: 100%;
            margin-top: 4px;
            padding: 6px;
            background: #333;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 4px;
        }

        button:hover {
            background: #444;
        }

        /* Save/Reset buttons */
       #saveReset {
		position: absolute;
		top: 10px;
		left: 10px;
		display: flex;
		flex-direction: column; /* stack rows vertically */
		gap: 10px;
		z-index: 50;
	}


        #recentFind {
    position: absolute;
    top: 10px;                     
    left: 1100px;                  
    width: 350px;

    /* Make it taller to fit 5 ore items */
    height: auto;           /* allow content to define height */
    max-height: 240px;      /* limit maximum height */
    min-height: 240px;      /* optional: minimum starting height */

    background: #222;
    border: 2px solid #fff;
    border-radius: 10px;
    padding: 10px;
    color: white;
    font-family: Arial;
	text-align: center;
    margin: 0 0 10px 0;
    z-index: 10;
}
#recentFindContent {
    text-align: center;       /* centers text inside each ore div */
    display: flex;            /* make items flexible */
    flex-direction: column;   /* stack ores vertically */
    align-items: center;      /* horizontally center each ore */
    gap: 5px;                 /* optional: spacing between ores */
}


        /* Block counters top right */
        #blockCounters {
            position: absolute;
            top: 10px;
            right: 10px;
            text-align: right;
            color: white;
            font-family: Arial;
            z-index: 50;
        }

        /* Spawn message overlay */
        #spawnMessage {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0,0,0,0.85);
            padding: 25px 50px;
            border-radius: 15px;
            font-size: 26px;
            font-weight: bold;
            text-align: center;
            display: none;
            z-index: 9999;
        }

        /* Spawn effect overlay */
        #spawnEffect {
            position: fixed;
            top: 0; left: 0;
            width: 100%; height: 100%;
            background: transparent;
            pointer-events: none;
            z-index: 9998;
            transition: background 5s linear;
        }

        @keyframes imaginaryPulseAnim {
            0%   { transform: translate(-50%, -50%) scale(1.5); }
            50%  { transform: translate(-50%, -50%) scale(2.3); }
            100% { transform: translate(-50%, -50%) scale(1.5); }
        }

        /* Ore Index and Inventory wrapper */
        #bottomPanels {
            display: flex;
            width: 1280px;
            margin-top: 10px;
            gap: 10px;
        }
		.button-row {
		display: flex;
		gap: 10px;       /* space between buttons */
		}


        #oreIndex, #inventory {
            padding: 10px;
            background: #181818;
            overflow-y: auto;
            border-radius: 8px;
            color: white;
        }

        #oreIndex {
            width: 400px;
            height: 150px;
        }

        #inventory {
            width: 900px;
            height: 150px;
        }

        /* Ore Viewer panel */
        #oreViewer {
            position: fixed;
            bottom: 10px;
            right: 10px;
            width: 200px;
            height: 200px;
            background:#222;
            border:2px solid #fff;
            border-radius:10px;
            display:none;
            text-align:center;
            padding:10px;
            color:white;
        }

        #oreBlock {
            width:100%;
            height:120px;
            margin-bottom:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:50px;
        }

        #oreName {
            font-weight:bold;
            font-size:12px;
        }

        #oreRarity {
            margin-bottom:10px;
        }

        #replaySpawn {
        width: 100%;
        font-size: 12px;       /* smaller button text */
        padding: 6px;
        margin-top: 4px;
        box-sizing: border-box;
    }
	
	.event-text {
    font-weight: bold;
    -webkit-text-stroke: 1px white;
}

/* üåå Space = White */
.event-space {
    color: black;
}

/* üåä Ocean = Blue */
.event-ocean {
    color: #00bfff;
}

/* ‚ò¢ Nuclear = Green */
.event-nuclear {
    color: #39ff14;
}

/* üî• Fire = Orange */
.event-fire {
    color: #ff6600;
}
.event-computer {
    color: #61665f;
}


/* üß¨ Evolie = Rainbow */
.event-evolie {
    background: linear-gradient(
        90deg,
        red,
        orange,
        yellow,
        green,
        blue,
        indigo,
        violet
    );
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
}
		/* =========================
   üì± MOBILE FIX (NO PC CHANGES)
   ========================= */

@media (max-width: 768px) {

    body {
        align-items: center;
        padding: 10px;
        overflow-x: hidden;
    }

    /* Canvas scaling */
    #game {
        margin-left: 0 !important;
        width: 90vw;
        height: 90vw;
        max-width: 350px;
        max-height: 350px;
    }

    /* Recent finds becomes normal block */
    #recentFind {
        position: relative !important;
        left: auto !important;
        top: auto !important;
        width: 95%;
        max-width: 400px;
        margin: 10px auto;
    }

    /* Save buttons stack */
    #saveReset {
        position: relative !important;
        flex-wrap: wrap;
        justify-content: center;
        gap: 5px;
        margin-bottom: 10px;
    }

    #saveReset button {
        width: 48%;
        font-size: 13px;
        padding: 8px;
    }

    /* Block counters move into flow */
    #blockCounters {
        position: relative !important;
        text-align: center;
        margin-bottom: 10px;
    }

    /* Main UI panels stack vertically */
    #ui {
        width: 100% !important;
        flex-direction: column;
        align-items: center;
    }

    #pickaxeUI,
    #gearUI,
    #artefactUI,
    #luckArtefactUI {
        width: 95% !important;
        height: auto;
        max-height: 250px;
        margin-right: 0;
    }

    /* Bottom panels stack */
    #bottomPanels {
        flex-direction: column;
        width: 100% !important;
    }

    #oreIndex,
		#inventory {
        width: 95% !important;
        height: 200px;
    }

	#oreViewer {
		display: none;
        width: 80%;           /* smaller width */
        max-width: 250px;     /* max width */
        height: auto;         /* allow height to adjust */
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        padding: 6px;
        font-size: 12px;      /* smaller base font */
        z-index: 99999;
        flex-direction: column;
        align-items: center;
        box-sizing: border-box;
    }

    /* Ore block inside viewer */
    #oreBlock {
        width: 100%;
        height: 80px;         /* reduce height for mobile */
        font-size: 40px;      /* scale symbol size */
        margin-bottom: 6px;
    }

    /* Ore name and rarity */
    #oreName, #oreRarity {
        font-size: 12px;      /* smaller text */
        text-align: center;
        margin-bottom: 4px;
        word-break: break-word; /* prevent overflow */
    }

    /* Replay button */
    #replaySpawn {
        width: 100%;
        font-size: 12px;       /* smaller button text */
        padding: 6px;
        margin-top: 4px;
        box-sizing: border-box;
    }

	/* Bigger tap buttons for mobile */
	button {
		font-size: 14px;
		padding: 10px;
	}
	#spawnMessage {
        top: 10px;             /* position near top of viewport */
        left: 50%;             /* keep horizontally centered */
        transform: translateX(-50%); /* horizontal centering only */
        font-size: 20px;       /* slightly smaller for mobile */
        padding: 15px 25px;    /* adjust padding */
        border-radius: 10px;   /* softer corners */
    }
}



    </style>
</head>
<body>

    <div id="saveReset">
    <!-- First row -->
    <div class="button-row">
        <button onclick="saveGame()">Save</button>
        <button id="sortToggle" onclick="toggleSort()">Sort: Common ‚Üí Rarest</button>
        <button id="compactToggle" onclick="toggleCompact()">Compact: Off</button>
    </div>

    <!-- Second row -->
    <div class="button-row">
        <button id="volumeToggle" onclick="toggleVolume()">Volume: 100%</button>
        <button id="spawnFilterToggle" onclick="toggleSpawnFilter()">Spawn Filter: Exotic+</button>
        <button id="spawnToggle" onclick="toggleSpawn()">Spawn Messages: On</button>
    </div>
</div>
<div id="caveInfoBox" style="
    margin-top: 8px;
    margin-right: 100px;      
    padding: 12px;          
    border: 2px solid black;
    background: #111;
    color: white;
    font-size: 16px;        
    width: 200px;           
    min-height: 50px;      
">
    No Cave Active
</div>




    <div id="spawnEffect"></div>

    <!-- Canvas -->
    <canvas id="game" width="270" height="270"></canvas>

    <!-- Recent Finds -->
    <div id="recentFind">
        <h3>Recent Finds</h3>
        <div id="recentFindContent"></div>
    </div>
	<div id="eventBox" class="event-box">No event active</div>
    <!-- Main UI panels -->
    <div id="ui">
        <div id="pickaxeUI"><h3>Pickaxes</h3></div>
        <div id="gearUI"><h3>Gear</h3></div>
        <div id="artefactUI"><h3>Auto-Miner Artefact</h3></div>
        <div id="luckArtefactUI"><h3>Luck Artefact</h3></div>
    </div>

    <!-- Block counters -->
    <div id="blockCounters">
        <div id="totalMined">Total Mined: 0</div>
        <div id="globalMined">Global Mined: 0</div>
    </div>

    <!-- Bottom panels -->
    <div id="bottomPanels">
        <div id="oreIndex">
            <h3>Ore Index</h3>
        </div>
        <div id="inventory">
            <h3>Inventory</h3>
        </div>
    </div>
	

    <!-- Ore Viewer -->
    <div id="oreViewer">
        <div id="oreBlock"></div>
        <div id="oreName"></div>
        <div id="oreRarity"></div>
        <button id="replaySpawn">Replay Spawn Message & Sound</button>
    </div>

    <!-- Spawn Message -->
    <div id="spawnMessage"></div>

    <!-- Audio -->
    <audio id="Achillgoesdownyourspine" src="Achillgoesdownyourspine.mp3" preload="auto"></audio>
    <audio id="Yourheartskipsabeat" src="Yourheartskipsabeat.mp3" preload="auto"></audio>
    <audio id="Transcendent" src="Transcendent.mp3" preload="auto"></audio>
    <audio id="Enigmatic" src="Enigmatic.mp3" preload="auto"></audio>
    <audio id="Unfathomable" src="Unfathomable.mp3" preload="auto"></audio>
    <audio id="Otherworldly" src="Otherworldly.mp3" preload="auto"></audio>
    <audio id="Imaginary" src="Imaginary.mp3" preload="auto"></audio>
    <audio id="Zenith" src="Zenith.mp3"></audio>
    <audio id="Eternal" src="Eternal.mp3"></audio>

</body>

<script>
        // Unlock audio on first click
        document.body.addEventListener("click", () => {
            audioEnabled = true;
        });

        const canvas = document.getElementById("game");
        const ctx = canvas.getContext("2d");
        const SIZE = 90;
        const GRID = 3;

        let grid = [];
        let inventory = {};
        let ownedPickaxes = ["T0"];
        let equippedPickaxe = "T0";
        let ownedGears = [];
        let equippedGears = [];
        let artefactLevel = 0;
        let luckArtefactLevel = 0;
        let pauseOnChill = false;
        let waitingForManualHighOre = false;
        let totalBlocksMined = 0;
        let globalBlocksMined = 0;
        let artefactInterval = null;
        let sortRarestFirst = false; // false = Common ‚Üí Rarest, true = Rarest ‚Üí Common
        let audioEnabled = false;
        let spawnLock = false;
		let compactNumbers = false;
		let recentFinds = [];
		let volumeLevels = [1, 0.75, 0.5, 0.25, 0.05, 0];
		let currentVolumeIndex = 0;
		let spawnMessagesEnabled = true;
		let spawnSoundFilter = "Exotic"; // default = hear all
		let blocksMined = 0;
		let activeCave = null;
		let caveEndAt = 0;
		let lastCaveEndAt = 0;
		const CAVE_INTERVAL = 100000;   // 100k blocks
		const CAVE_DURATION = 25000;     // lasts 25k blocks
		let currentEvent = null;

const events = ["space", "ocean", "nuclear", "fire", "evolie", "computer"];

function startEventSystem() {
    const eventBox = document.getElementById("eventBox");

    // Initially no event
    eventBox.innerText = "No event active";

    // Start event rotation almost immediately
    setTimeout(() => {
        rotateEvent(); // first event

        setInterval(() => {
            rotateEvent(); // rotate every 5 minutes
        }, 300000); // 300000ms = 5min
    }, 500);
}

function rotateEvent() {
    let newEvent;
    do {
        newEvent = events[Math.floor(Math.random() * events.length)];
    } while (newEvent === currentEvent);

    currentEvent = newEvent;

    const eventBox = document.getElementById("eventBox");

    const displayNames = {
        space: "Strange distortions ripple overhead",
        ocean: "A distant tide can be felt",
        nuclear: "The air vibrates faintly",
        fire: "The temperature rises unnaturally",
        evolie: "Something is evolving",
        computer: "The system behaves‚Ä¶ differently"
    };

    // Reset class first
    eventBox.className = "event-box event-text";

    // Add event-specific color class
    switch (currentEvent) {
        case "space": eventBox.classList.add("event-space"); break;
        case "ocean": eventBox.classList.add("event-ocean"); break;
        case "nuclear": eventBox.classList.add("event-nuclear"); break;
        case "fire": eventBox.classList.add("event-fire"); break;
        case "evolie": eventBox.classList.add("event-evolie"); break;
        case "computer": eventBox.classList.add("event-computer"); break;
    }

    eventBox.innerText = displayNames[currentEvent];
}

const caveTypes = {

    NormalCave: {
        caveBlocks: ["CaveStone", "CaveCoal", "CaveIron"],
        exclusiveOres: ["EternalCrystal", "MythicObelisk"],
        rareChance: 0.5 // 1 in 2
    },

    IceCave: {
        caveBlocks: ["Ice"],
        exclusiveOres: ["CrystalFrost"],
        rareChance: 1/8
    },

    EnergyCave: {
        caveBlocks: ["Energy"],
        exclusiveOres: ["GlowingNova", "ZenithShard"],
        rareChance: 1/12
    },

    NuclearCave: {
        caveBlocks: ["NuclearWaste"],
        exclusiveOres: ["RadiantCore"],
        rareChance: 1/45
    },

    ShadowCave: {
        caveBlocks: ["ShadowMatter"],
        exclusiveOres: ["ShadowGem", "VoidOrb"],
        rareChance: 1/66
    },

    AbyssCave: {
        caveBlocks: ["AbyssSand"],
        exclusiveOres: ["AbyssCrystal","AbyssFish"],
        rareChance: 1/100
    },

    LavaCave: {
        caveBlocks: ["LavaRock"],
        exclusiveOres: ["LavaRelic"],
        rareChance: 1/250
    }
};


function checkForCaveSpawn() {
    if (activeCave) return; // cave already active

    // Blocks mined since last cave ended
    const blocksSinceLastCave = blocksMined - lastCaveEndAt;
    if (blocksSinceLastCave < CAVE_INTERVAL) return;

    const caveKeys = Object.keys(caveTypes);

    for (let i = 0; i < caveKeys.length; i++) {
        const caveKey = caveKeys[i];
        const cave = caveTypes[caveKey];

        if (Math.random() < cave.rareChance) {
            activeCave = cave;
            activeCave.startTime = Date.now();
            caveEndAt = blocksMined + CAVE_DURATION;
            console.log(`A ${caveKey} has appeared!`);
            return;
        }
    }
}


function updateCaveUI() {
    const box = document.getElementById("caveInfoBox");

    if (!activeCave) {
        box.innerHTML = "No Cave Active";
        box.style.background = "#111";
        return;
    }

    const blocksLeft = caveEndAt - blocksMined;

    // Find cave name
    const caveName = Object.keys(caveTypes).find(
        key => caveTypes[key] === activeCave
    );

    // Format rare chance (ex: 1 in 8)
    const chanceText = `1 in ${Math.round(1 / activeCave.rareChance)}`;

    box.innerHTML = `
        ${caveName} Active<br>
        Exclusive Chance: ${chanceText}<br>
        Blocks Left: ${blocksLeft}
    `;

    box.style.background = "#222";
}
function updateCaveUI() {
    const box = document.getElementById("caveInfoBox");

    if (!activeCave) {
        box.innerHTML = "No Cave Active";
        box.style.background = "#111";
        return;
    }

    const blocksLeft = Math.max(caveEndAt - blocksMined, 0);

    const caveName = Object.keys(caveTypes).find(
        key => caveTypes[key] === activeCave
    );

    const chanceText = `1 in ${Math.round(1 / activeCave.rareChance)}`;

    box.innerHTML = `
        ${caveName} Active<br>
        Exclusive Chance: ${chanceText}<br>
        Blocks Left: ${blocksLeft.toLocaleString()}
    `;

    box.style.background = "#222";

    // Automatically end cave when blocks reach zero
    if (blocksLeft <= 0) {
        activeCave = null;
		lastCaveEndAt = blocksMined; 
        box.innerHTML = "No Cave Active";
        console.log("The cave has collapsed.");
    }
}


		function toggleSpawn() {
    spawnMessagesEnabled = !spawnMessagesEnabled;
    document.getElementById("spawnToggle").innerText =
        `Spawn Messages: ${spawnMessagesEnabled ? "On" : "Off"}`;
}

		
		function toggleCompact() {
			compactNumbers = !compactNumbers;
			document.getElementById("compactToggle").innerText = 
				`Compact: ${compactNumbers ? "On" : "Off"}`;
			updateCounters();
			updateUI();
		}

// Helper to format numbers compactly
	function formatNumber(n) {
		if (!compactNumbers) return n.toLocaleString();
		if (n >= 1e15) return (n / 1e15).toFixed(2) + "QD"; // Quadrillion
		if (n >= 1e12) return (n / 1e12).toFixed(2) + "T";  // Trillion
		if (n >= 1e9)  return (n / 1e9).toFixed(2) + "B";   // Billion
		if (n >= 1e6)  return (n / 1e6).toFixed(2) + "M";   // Million
		if (n >= 1e3)  return (n / 1e3).toFixed(1) + "K";   // Thousand
		return n.toString();
	}
	function toggleVolume() {
    currentVolumeIndex++;
    if (currentVolumeIndex >= volumeLevels.length) {
        currentVolumeIndex = 0;
    }

    const volume = volumeLevels[currentVolumeIndex];

    document.getElementById("volumeToggle").innerText =
        "Volume: " + Math.round(volume * 100) + "%";

    // Apply volume to ALL audio elements
    document.querySelectorAll("audio").forEach(a => {
        a.volume = volume;
    });
}
	
       function playSpawnSound(ore) {
    if (!spawnMessagesEnabled) return;
    if (spawnLock) return;

    const data = oreData[ore];
    if (!data || !data.spawnMsg) return;

    spawnLock = true;

    const msgDiv = document.getElementById("spawnMessage");
    msgDiv.innerText = data.spawnMsg;
	msgDiv.classList.remove("event-text");
    msgDiv.style.color = rarityColors[data.rarity] || "#ffffff";
    msgDiv.style.display = "block";

    let audioId = null;

    // Special mapping for cave-exclusive and unique ores
    const specialRaritySounds = {
        "IceCaveExclusive-Exotic": "Achillgoesdownyourspine",
        "EnergyCaveExclusive-Exquisite": "Yourheartskipsabeat",
        "EnergyCaveExclusive-Zenith": "Zenith",
        "NuclearCaveExclusive-Transcendent": "Transcendent",
        "ShadowCaveExclusive-Enigmatic": "Enigmatic",
        "ShadowCaveExclusive-Imaginary": "Imaginary",
        "AbyssCaveExclusive-Unfathomable": "Unfathomable",
        "AbyssCaveExclusive-Zenith": "Zenith",
        "LavaCaveExclusive-Otherworldly": "Otherworldly",
        "CaveExclusive-Mythical": "Otherworldly",
        "CaveExclusive-Eternal": "Eternal"
    };

    // Use the special audio if it exists for this ore's rarity
    if (specialRaritySounds[data.rarity]) {
        audioId = specialRaritySounds[data.rarity];
    } else {
        // Otherwise, use the numeric "exact" ranges
        const exact = data.exact;
        if (exact >= 250000 && exact < 10000000) audioId = "Achillgoesdownyourspine";
        else if (exact >= 10000000 && exact < 25000000) audioId = "Yourheartskipsabeat";
        else if (exact >= 25000000 && exact < 60000000) audioId = "Transcendent";
        else if (exact >= 60000000 && exact < 100000000) audioId = "Enigmatic";
        else if (exact >= 100000000 && exact < 295000000) audioId = "Unfathomable";
        else if (exact >= 295000000 && exact < 1000000000) audioId = "Otherworldly";
        else if (exact >= 1000000000 && exact < 50000000000) audioId = "Imaginary";
        else if (exact >= 50000000000 && exact < 1000000000000) audioId = "Zenith";
        else if (exact >= 1000000000000) audioId = "Eternal";
    }

    function unlock() {
        msgDiv.style.display = "none";
        spawnLock = false;
    }

    if (!audioEnabled || !audioId) {
        setTimeout(unlock, 5000);
        return;
    }

    const audio = document.getElementById(audioId);
    if (!audio) { setTimeout(unlock, 5000); return; }

    audio.pause();
    audio.currentTime = 0;

    audio.play().then(() => {

        /* =========================
           üî• ETERNAL EFFECT
        ========================== */
        if (data.rarity === "Eternal" || data.rarity === "SPAFF"|| data.rarity === "CaveExclusive-Eternal") {
            const overlay = document.getElementById("spawnEffect");
            overlay.style.transition = "background 0s linear";
            overlay.style.background = "transparent";

            setTimeout(() => {
                overlay.style.transition = "background 5s linear";
                overlay.style.background = "white";
            }, 50);

            setTimeout(() => {
                overlay.style.transition = "background 5s linear";
                overlay.style.background = "rgba(100,100,100,0.7)";
            }, 5050);

            audio.onended = () => {
                overlay.style.transition = "background 1s linear";
                overlay.style.background = "transparent";
                unlock();
            };
            return;
        }

        /* =========================
           üåå ZENITH EFFECT
        ========================== */
        if (data.rarity === "Zenith"|| data.rarity === "AbyssCaveExclusive-Zenith"|| data.rarity === "EnergyCaveExclusive-Zenith") {
            const numDivs = 5;
            const spawnDivs = [];

            function isOverlapping(x, y, size = 150) {
                return spawnDivs.some(d =>
                    Math.abs(d.x - x) < size &&
                    Math.abs(d.y - y) < size
                );
            }

            for (let i = 0; i < numDivs; i++) {
                let x, y, attempts = 0;
                do {
                    x = Math.random() * (window.innerWidth - 200) + 50;
                    y = Math.random() * (window.innerHeight - 200) + 50;
                    attempts++;
                } while (isOverlapping(x, y) && attempts < 20);

                const div = document.createElement("div");
                div.innerText = data.spawnMsg;
                div.style.position = "fixed";
                div.style.left = x + "px";
                div.style.top = y + "px";
                div.style.fontSize = "24px";
                div.style.fontWeight = "bold";
                div.style.color = rarityColors["Zenith"];
                div.style.pointerEvents = "none";
                div.style.zIndex = 10000;

                document.body.appendChild(div);
                spawnDivs.push({ div, x, y });
            }

            let angle = 0;
            const spinInterval = setInterval(() => {
                angle += 5;
                spawnDivs.forEach(d =>
                    d.div.style.transform = `rotate(${angle}deg)`
                );
            }, 50);

            audio.onended = () => {
                clearInterval(spinInterval);
                spawnDivs.forEach(d => d.div.remove());
                unlock();
            };
            return;
        }

        /* =========================
           üå† IMAGINARY EFFECT
        ========================== */
        if (data.rarity === "Imaginary"|| data.rarity === "ShadowCaveExclusive-Imaginary") {
            const canvas = document.getElementById("game");
            const block = document.createElement("div");

            block.style.position = "absolute";
            block.style.top = canvas.offsetTop + canvas.height / 2 + "px";
            block.style.left = canvas.offsetLeft + canvas.width / 2 + "px";
            block.style.transform = "translate(-50%, -50%) scale(1.5)";
            block.style.width = "180px";
            block.style.height = "180px";
            block.style.display = "flex";
            block.style.alignItems = "center";
            block.style.justifyContent = "center";
            block.style.borderRadius = "20px";
            block.style.zIndex = "10000";
            block.style.pointerEvents = "none";
            block.style.animation = "imaginaryPulseAnim 1.5s infinite ease-in-out";
            block.style.background = "transparent";

            const img = oreImages[ore];
            if (img) {
                img.style.width = "100%";
                img.style.height = "100%";
                img.style.objectFit = "contain";
                block.appendChild(img.cloneNode());
            } else {
                block.style.background = data.color;
                const span = document.createElement("span");
                span.innerText = data.symbol || "";
                span.style.fontSize = "70px";
                span.style.fontWeight = "bold";
                span.style.color = data.symbolColor || "#fff";
                block.appendChild(span);
            }

            document.body.appendChild(block);

            audio.onended = () => {
                block.remove();
                unlock();
            };
            return;
        }
// ==========================
// EVENT TEXT ADDITION
// ==========================
const eventData = getEventText(); // Should return currentEvent + display text

if (
    eventData &&
    data.event === currentEvent &&  // <-- make it event-locked
    data.rarity !== "Eternal" &&
    data.rarity !== "SPAFF" &&
    data.exact >= 250000
) {
    const eventLine = document.createElement("div");
    eventLine.innerText = eventData.text;
    eventLine.classList.add("event-text", eventData.class);

    msgDiv.appendChild(document.createElement("br"));
    msgDiv.appendChild(eventLine);
}

        /* =========================
           NORMAL RARITIES
        ========================== */
        audio.onended = unlock;

    }).catch(() => {
        setTimeout(unlock, 5000);
    });
}


function updateRecentFind(ore) {
    const data = oreData[ore];

    if (data.exact < 250000) return; // only rare/high-tier ores

    recentFinds.unshift({
        name: ore,
        rarity: data.rarity,
        exact: data.exact,
        color: data.color,
        symbol: data.symbol || ""
    });

    recentFinds = recentFinds.slice(0, 5);

    const div = document.getElementById("recentFindContent");
    div.innerHTML = "";

    recentFinds.forEach(f => {
        const fDiv = document.createElement("div");
        fDiv.style.display = "flex";
        fDiv.style.alignItems = "center";
        fDiv.style.marginBottom = "6px";

        const box = document.createElement("div");
        box.style.width = "24px";
        box.style.height = "24px";
        box.style.marginRight = "6px";
        box.style.display = "flex";
        box.style.alignItems = "center";
        box.style.justifyContent = "center";
        box.style.fontWeight = "bold";

        if (oreImages[f.name]) {
            const img = oreImages[f.name].cloneNode(); // clone so multiple uses don‚Äôt interfere
            img.style.width = "24px";
            img.style.height = "24px";
            box.appendChild(img);
        } else {
            box.style.background = f.color;
            box.style.color = "#fff";
            box.innerText = f.symbol;
        }

        const text = document.createElement("div");
        text.innerText = `${f.name} (${f.rarity}) - 1 in ${formatNumber(f.exact)}`;
        text.style.fontSize = "14px";
        text.style.flex = "1";

        fDiv.appendChild(box);
        fDiv.appendChild(text);
        div.appendChild(fDiv);
    });
}


function toggleSpawnFilter() {
    const rarities = ["Exotic","Exquisite","Transcendent","Enigmatic","Unfathomable","Otherworldly","Imaginary","Zenith","Eternal"];
    let currentIndex = rarities.indexOf(spawnSoundFilter);
    currentIndex = (currentIndex + 1) % rarities.length;
    spawnSoundFilter = rarities[currentIndex];
    document.getElementById("spawnFilterToggle").innerText = `Spawn Filter: ${spawnSoundFilter}+`;
}
function tryPlaySpawnSound(ore) {
    if (!spawnMessagesEnabled) return; // global off
    const oreRarityIndex = rarityOrder.indexOf(oreData[ore].rarity);
    const filterIndex = rarityOrder.indexOf(spawnSoundFilter);

    if (oreRarityIndex >= filterIndex) {
        setTimeout(() => playSpawnSound(ore), 50);
    }
}

      

        function toggleSort() {
            sortRarestFirst = !sortRarestFirst;
            document.getElementById("sortToggle").innerText =
                "Sort: " + (sortRarestFirst ? "Rarest ‚Üí Common" : "Common ‚Üí Rarest");
            updateUI(); // redraw inventory with new sorting
        }
// Ore Data
const oreData = {
    Stone:{rarity:"Common",value:1,color:"#777",exact:3},
    Coal:{rarity:"Common",value:2,color:"#444",exact:10},
    Iron:{rarity:"Uncommon",value:3,color:"#aaa",exact:20},
    Emerald:{rarity:"Rare",value:4,color:"#2ecc71",symbol:"E",exact:35},
    Ruby:{rarity:"Epic",value:5,color:"#e91e63",symbol:"R",exact:50},
    Sapphire:{rarity:"Legendary",value:6,color:"#2196f3",symbol:"S",exact:75},
    Topaz:{rarity:"Legendary",value:7,color:"#ff9800",symbol:"T",exact:100},
    Diamond:{rarity:"Legendary",value:8,color:"#00ffff",symbol:"D",exact:150},
    Void:{rarity:"Legendary",value:9,color:"#9c27b0",symbol:"V",exact:250},
    Gold:{rarity:"Legendary+",value:10,color:"#ffd700",symbol:"G",exact:1000},
    Mega:{rarity:"Legendary+",value:11,color:"#ff9800",symbol:"M",exact:10000},
    UltraMega:{rarity:"Mythic",value:12,color:"#ff5722",symbol:"U",exact:25000},
    HyperMega:{rarity:"Mythic",value:13,color:"#e91e63",symbol:"H",exact:50000},
    Giga:{rarity:"Mythical",value:14,color:"#2196f3",symbol:"G",exact:100000},
    Smiley:{rarity:"Exotic",value:15,color:"#ffeb3b",symbol:"üòä",spawnMsg:"A chill goes down your spine!",exact:250000},
    Tera:{rarity:"Exotic",value:16,color:"#9c27b0",symbol:"T",spawnMsg:"A chill goes down your spine!",exact:500000},
    TeraPlus:{rarity:"Exotic",value:17,color:"#ff4081",symbol:"TP",spawnMsg:"A chill goes down your spine!",exact:1000000},
    Peta:{rarity:"Exotic",value:18,color:"#00bcd4",symbol:"P",spawnMsg:"A chill goes down your spine!",exact:5000000},
    PetaPlus1:{rarity:"Exquisite",value:19,color:"#ff4081",symbol:"PP1",spawnMsg:"Your heart skips a beat!",exact:10000000},
    PetaPlus2:{rarity:"Transcendent",value:20,color:"#cddc39",symbol:"PP2",spawnMsg:"You hear a ringing!",exact:25000000},
    PetaPlus3:{rarity:"Transcendent",value:21,color:"#ff5722",symbol:"PP3",spawnMsg:"You hear a ringing!",exact:51000000},
    PetaPlus4:{rarity:"Enigmatic",value:22,color:"#00bcd4",symbol:"PP4",spawnMsg:"Your vision begins to blur!",exact:75000000},
    VoidPlus:{rarity:"Unfathomable",value:23,color:"#8e24aa",symbol:"VP",spawnMsg:"A ripple runs through the cosmos as you uncover the VoidPlus!",exact:250000000},
    VoidUltra:{rarity:"Otherworldly",value:24,color:"#000",symbol:"VU",spawnMsg:"The universe trembles! You've discovered the legendary VoidUltra!",exact:500000000},
    Infinity:{rarity:"Imaginary",value:25,color:"#000",symbol:"‚àû",symbolColor:"#fff",spawnMsg:"You feel the universe itself watching you!",exact:1000000000},
    NovaShard:{rarity:"Exquisite",value:26,color:"#ff6ec7",symbol:"NS",spawnMsg:"Your heart skips a beat!",exact:12000000},
    Celestium:{rarity:"Exquisite",value:27,color:"#7c4dff",symbol:"CE",spawnMsg:"Your heart skips a beat!",exact:15000000},
    Astralite:{rarity:"Exquisite",value:28,color:"#00e5ff",symbol:"AS",spawnMsg:"Your heart skips a beat!",exact:18000000},
    Luminite:{rarity:"Exquisite",value:29,color:"#ffd740",symbol:"LU",spawnMsg:"Your heart skips a beat!",exact:21000000},
    EclipseCore:{rarity:"Exquisite",value:30,color:"#ff1744",symbol:"EC",spawnMsg:"Your heart skips a beat!",exact:24000000},
    OblivionShard:{rarity:"Enigmatic",value:31,color:"#263238",symbol:"OS",spawnMsg:"Your vision begins to blur!",exact:85000000},
    PhantomCrystal:{rarity:"Enigmatic",value:32,color:"#37474f",symbol:"PC",spawnMsg:"Your vision begins to blur!",exact:95000000},
    AbyssalCore:{rarity:"Unfathomable",value:33,color:"#4a148c",symbol:"AC",spawnMsg:"A bottomless abyss opens beneath your feet...",exact:150000000},
    DarkMatter:{rarity:"Unfathomable",value:34,color:"#1a237e",symbol:"DM",spawnMsg:"Gravity distorts violently around the Dark Matter!",exact:220000000},
    CosmicRelic:{rarity:"Otherworldly",value:35,color:"#ff6867",symbol:"CR",symbolColor:"#00ffff",spawnMsg:"The fabric of existence tears apart!",exact:750000000},
    Singularity:{rarity:"Imaginary",value:36,color:"#000000",symbol:"Œ©",symbolColor:"#ff00ff",spawnMsg:"Time stops. Space collapses. You found the impossible.",exact:2000000000},
    AlterDemon:{rarity:"Divine",value:37,color:"#000000",symbol:"AD",symbolColor:"#ff0000",spawnMsg:"Alters demon is here to catch you",exact:1000000},
    Veritcal:{rarity:"Imaginary",value:38,color:"#90D5FF",symbol:"Vert",symbolColor:"#000000",spawnMsg:"You shouldn't dig straight down",exact:4444444444, imgSrc: "Vert.png"},
    Zanacharium:{rarity:"Zenith",value:39,color:"#DF03FC",symbol:"?",symbolColor:"#000000",spawnMsg:"An unusual force materializes upon the surface of this world...",exact:68750000000},
    Chronovexium:{rarity:"Zenith",value:40,color:"#00F0FF",symbol:"‚è≥",symbolColor:"#000000",spawnMsg:"Time fractures as Chronovexium emerges from the continuum...",exact:125000000000},
    Aetherion:{rarity:"Zenith",value:41,color:"#FFD700",symbol:"‚ú∂",symbolColor:"#000000",spawnMsg:"The heavens shimmer as Aetherion descends into existence...",exact:350000000000},
    Paradoxium:{rarity:"Eternal",value:42,color:"#6A00FF",symbol:"Œ®",symbolColor:"#FFFFFF",spawnMsg:"Reality twists into an impossible shape as Paradoxium manifests...",exact:1500000000000},
    GenesisFragment:{rarity:"Eternal",value:43,color:"#FFFFFF",symbol:"‚ú¶",symbolColor:"#000000",spawnMsg:"A spark of creation ignites as the Genesis Fragment forms...",exact:5000000000000},
    BlueTheFR:{rarity:"Eternal",value:44,color:"#00FBFF",symbol:"Blue",symbolColor:"#FFFFFF",spawnMsg:"You meet the creator...",exact:100000000000000, imgSrc: "Blue.png"},
    Nebulium:{rarity:"Transcendent", value:45, color:"#76ff03", symbol:"N", spawnMsg:"You hear a ringing!", exact:26000000},
    Stellarium:{rarity:"Transcendent", value:46, color:"#00bcd4", symbol:"St", spawnMsg:"You hear a ringing!", exact:28000000},
    Lunarium:{rarity:"Transcendent", value:47, color:"#ffeb3b", symbol:"L", spawnMsg:"You hear a ringing!", exact:30000000},
    Solarium:{rarity:"Transcendent", value:48, color:"#ff9800", symbol:"So", spawnMsg:"You hear a ringing!", exact:32000000},
    Aetherium:{rarity:"Transcendent", value:49, color:"#8bc34a", symbol:"Ae", spawnMsg:"You hear a ringing!", exact:35000000},
    Chronium:{rarity:"Transcendent", value:50, color:"#00ffff", symbol:"Ch", spawnMsg:"You hear a ringing!", exact:38000000},
    Quantumite:{rarity:"Transcendent", value:51, color:"#2196f3", symbol:"Q", spawnMsg:"You hear a ringing!", exact:40000000},
    Hyperion:{rarity:"Transcendent", value:52, color:"#ff4081", symbol:"Hy", spawnMsg:"You hear a ringing!", exact:45000000},
    Vortexium:{rarity:"Transcendent", value:53, color:"#9c27b0", symbol:"Vx", spawnMsg:"You hear a ringing!", exact:52500000},
    Ecliptium:{rarity:"Transcendent", value:54, color:"#ff5722", symbol:"Ec", spawnMsg:"You hear a ringing!", exact:55000000},
    OblivionCore:{rarity:"Enigmatic", value:55, color:"#37474f", symbol:"OC", spawnMsg:"Your vision begins to blur!", exact:90000000},
    Abyssion:{rarity:"Otherworldly", value:56, color:"#8b0000", symbol:"Ab", exact:525000000, spawnMsg:"The world trembles as Abyssion emerges!"},
    Eternium:{rarity:"Otherworldly", value:57, color:"#ff1744", symbol:"Et", exact:550000000, spawnMsg:"Eternium pulses with unimaginable energy!"},
    Voidessence:{rarity:"Otherworldly", value:58, color:"#6a1b9a", symbol:"Ve", exact:600000000, spawnMsg:"Voidessence warps the very fabric of existence!"},
    Cosmosite:{rarity:"Otherworldly", value:59, color:"#ff6867", symbol:"Co", exact:650000000, spawnMsg:"The cosmos quivers as Cosmosite forms!"},
    Singulite:{rarity:"Otherworldly", value:60, color:"#00ffff", symbol:"Si", exact:700000000, spawnMsg:"Singulite bends space and time around you!"},
    ZergHunter:{rarity:"Unfathomable", value:61, color:"#FF1300", symbol:"ZH", exact:100000000, spawnMsg:"Survive‚Ä¶ or become meat", imgSrc: "Zerghunter.png"},
    VoidShard:{rarity:"Mythical",value:62,color:"#00e5ff",symbol:"VS",exact:75000},
    FrostWraith:{rarity:"Exotic",value:63,color:"#00b0ff",symbol:"FW",spawnMsg:"A chill goes down your spine!",exact:750000},
    SoulGlacier:{rarity:"Exotic",value:64,color:"#9c27b0",symbol:"SG",spawnMsg:"A chill goes down your spine!",exact:2000000},
    EmberPhantom:{rarity:"Exotic",value:65,color:"#ff9800",symbol:"EP",spawnMsg:"A chill goes down your spine!",exact:3000000},
    CrimsonEclipse:{rarity:"Exotic",value:66,color:"#f44336",symbol:"CE",spawnMsg:"A chill goes down your spine!",exact:4000000},
    AbyssalSingularity:{rarity:"Unfathomable",value:67,color:"#000000",symbol:"AS",spawnMsg:"Reality distorts around you...",exact:200000000},
    AstralCataclysm:{rarity:"Otherworldly", value:68,color:"#1a237e",symbol:"AC",spawnMsg:"The sky fractures with alien light!",exact:300000000},
    VoidRequiem:{rarity:"Otherworldly", value:69,color:"#4a148c",symbol:"VR",spawnMsg:"A silent hymn echoes from beyond existence...",exact:400000000},
    EternalParadox:{rarity:"Otherworldly", value:70,color:"#b71c1c",symbol:"EPX",spawnMsg:"Time collapses. Something impossible has awakened.",exact:800000000},
    EclipseShard:{rarity:"Enigmatic",value:71,color:"#1c1c1c",symbol:"ES",spawnMsg:"Your vision begins to blur!",exact:60000000},
    ShadowFragment:{rarity:"Enigmatic",value:72,color:"#2f2f2f",symbol:"SF",spawnMsg:"Your vision begins to blur!",exact:61230000},
    TwilightGem:{rarity:"Enigmatic",value:73,color:"#512da8",symbol:"TG",spawnMsg:"Your vision begins to blur!",exact:63000000},
    OblivionStone:{rarity:"Enigmatic",value:74,color:"#263238",symbol:"OS",spawnMsg:"Your vision begins to blur!",exact:70000000},
    NightCore:{rarity:"Enigmatic",value:75,color:"#ff1744",symbol:"NC",spawnMsg:"Your vision begins to blur!",exact:77000000},
    SpecterGem:{rarity:"Enigmatic",value:76,color:"#37474f",symbol:"SG",spawnMsg:"Your vision begins to blur!",exact:81000000},
    AbyssGem:{rarity:"Enigmatic",value:77,color:"#4a148c",symbol:"AG",spawnMsg:"Your vision begins to blur!",exact:99000000},
    FrostShard:{rarity:"Unfathomable",value:78,color:"#00dfff",symbol:"FS",spawnMsg:"A shard of eternal frost crystallizes before your eyes!",exact:120000000},
    GlacierHeart:{rarity:"Unfathomable",value:79,color:"#00aaff",symbol:"GH",spawnMsg:"The heart of a glacier pulses, freezing everything around it!",exact:140000000},
    IceboundCore:{rarity:"Unfathomable",value:80,color:"#88eeff",symbol:"IC",spawnMsg:"IceboundCore emerges, encasing reality in glacial chains!",exact:180000000},
	Lugubre:{rarity:"Otherworldly",value:81,color:"#ffc7f8",symbol:"LU",spawnMsg:"INCROIYABLE luck !!!!!!!!!!!!!!!!!!",exact:850000000},
	AbyssHeart:{rarity:"Unfathomable",value:82,color:"#5e0f6f",symbol:"AH",spawnMsg:"A bottomless heart opens beneath you...",exact:230000000},
	VoidTitan:{rarity:"Unfathomable",value:83,color:"#4b0082",symbol:"VT",spawnMsg:"The VoidTitan awakens from the depths!",exact:240000000},
	CelestiteNova:{rarity:"Exquisite",value:84,color:"#ff80ab",symbol:"CN",spawnMsg:"Your heart skips a beat!",exact:12100000},
	AuroriteShard:{rarity:"Exquisite",value:85,color:"#80d8ff",symbol:"AS",spawnMsg:"Your heart skips a beat!",exact:13500000},
	LuminaraGem:{rarity:"Exquisite",value:86,color:"#ffd740",symbol:"LG",spawnMsg:"Your heart skips a beat!",exact:15500000},
	EclipseraCore:{rarity:"Exquisite",value:87,color:"#ff1744",symbol:"EC",spawnMsg:"Your heart skips a beat!",exact:17000000},
	EventideStar:{rarity:"Imaginary",value:88,color:"#0a0a0a",symbol:"EvS",spawnMsg:"A ripple of eternity whispers through the void as EventideStar appears!",exact:1200000000},
	QuantumCore:{rarity: "Imaginary",value: 89,color: "#00ffcc",symbol: "CPU",spawnMsg: "Digital circuits hum as QuantumCore boots the system!",exact: 1300000000},
	CosmoNova:{rarity:"Imaginary",value:90,color:"#141414",symbol:"CNV",spawnMsg:"Stars ignite and collapse in a cosmic dance around CosmoNova!",exact:1400000000},
	VoidEclipse:{rarity:"Imaginary",value:91,color:"#0d0d0d",symbol:"VE",spawnMsg:"Darkness stretches infinitely as VoidEclipse emerges from the void!",exact:1500000000},
	Nucleonix:{rarity:"Zenith",value:92,color:"#00ff00",symbol:"NU",spawnMsg:"Radiation hums as Nucleonix pulses with atomic energy!",exact:60000000000},
	Pyrocore:{rarity:"Zenith",value:93,color:"#ff4500",symbol:"PY",spawnMsg:"Flames swirl violently as Pyrocore erupts from the magma!",exact:500000000000}, 
	Aqualith:{rarity:"Zenith",value:94,color:"#00bfff",symbol:"AQ",spawnMsg:"Ocean currents converge as Aqualith emerges from the deep!",exact:300000000000}, 
	Circuitium:{rarity:"Zenith",value:95,color:"#cccccc",symbol:"CI",spawnMsg:"Digital sparks fly as Circuitium materializes from the grid!",exact:750000000000}, 
	Divinitium:{rarity: "Eternal",value: 96,color: "#ffffff",symbol: "DV",spawnMsg: "A blinding radiance heralds the arrival of Divinitium!",exact: 7000000000000},
	Atomarion:{rarity: "Unfathomable",value: 97,color: "#00ff66",symbol: "AT",spawnMsg: "A surge of atomic energy radiates as Atomarion manifests!",exact: 265000000},
	Infernium:{rarity: "Unfathomable",value: 98,color: "#ff3300",symbol: "IF",spawnMsg: "Molten fury erupts from Infernium, scorching all nearby!",exact: 285000000},
	Pyronis:{rarity: "Eternal",value: 99,color: "#ff6600",symbol: "PY",spawnMsg: "Flames twist violently as Pyronis bursts forth from molten rock!",exact: 4000000000000},
	SPAFF:{rarity: "SPAFF",value: 100,color: "#ff9900",symbol: "SPAFF",spawnMsg: "Le SPAFF est la!!",exact: 100000000000000000,imgSrc: "SPAFF.png"},
	CrystalFrost:{rarity:"IceCaveExclusive-Exotic",value:101,color:"#00ffff",symbol:"CF",spawnMsg:"A shard of CrystalFrost glimmers in the icy cave!",exact:500000},
	Ice: {rarity: "IceCaveExclusive",value: 0,color: "#88eeff",symbol: "", exact: 1},
	GlowingNova:{rarity:"EnergyCaveExclusive-Exquisite",value:102,color:"#ff00ff",symbol:"GN",spawnMsg:"GlowingNova illuminates the cavern with a soft pulse!",exact:1000000},
	ZenithShard:{rarity:"EnergyCaveExclusive-Zenith",value:103,color:"#DF03FC",symbol:"ZS",spawnMsg:"ZenithShard glows with impossible energy!",exact:60000000},
	Energy: {rarity: "EnergyCaveExclusive",value: 0,color: "#A327F5",symbol: "", exact: 1},
	RadiantCore:{rarity:"NuclearCaveExclusive-Transcendent",value:104,color:"#ffd700",symbol:"RC",spawnMsg:"RadiantCore radiates blinding light across the cave!",exact:3000000},
	NuclearWaste: {rarity: "NuclearCaveExclusive",value: 0,color: "#46F527",symbol: "", exact: 1},
	ShadowGem:{rarity:"ShadowCaveExclusive-Enigmatic",value:105,color:"#4b0082",symbol:"SG",spawnMsg:"ShadowGem distorts the shadows in the cavern!",exact:5000000},
	VoidOrb:{rarity:"ShadowCaveExclusive-Imaginary",value:106,color:"#000000",symbol:"VO",spawnMsg:"VoidOrb bends reality in the cavern!",exact:45000000},
	ShadowMatter: {rarity: "ShadowCaveExclusive",value: 0,color: "#313831",symbol: "", exact: 1},
	AbyssCrystal:{rarity:"AbyssCaveExclusive-Unfathomable",value:107,color:"#0d47a1",symbol:"AC",spawnMsg:"AbyssCrystal pulses with a bottomless energy!",exact:20000000},
	AbyssFish:{rarity:"AbyssCaveExclusive-Zenith",value:108,color:"#003fa3",symbol:"Fish",spawnMsg:"Fish!",exact:69019008, imgSrc: "fish.gif"},
	AbyssSand: {rarity: "AbyssCaveExclusive",value: 0,color: "#0B0E61",symbol: "", exact: 1},
	LavaRelic:{rarity:"LavaCaveExclusive-Otherworldly",value:108,color:"#ff4500",symbol:"LR",spawnMsg:"LavaRelic radiates heat as it emerges from molten rock!",exact:38000000},
	LavaRock: {rarity: "LavaCaveExclusive",value: 0,color: "#66584A",symbol: "", exact: 1},
	EternalCrystal:{rarity:"CaveExclusive-Eternal",value:110,color:"#00FBFF",symbol:"EC",spawnMsg:"EternalCrystal shines like the heart of creation!",exact:100000000},
	MythicObelisk:{rarity:"CaveExclusive-Mythical",value:111,color:"#ff5722",symbol:"MO",spawnMsg:"MythicObelisk towers impossibly, defying gravity!",exact:25000000},
	CaveStone:{rarity:"CaveExclusiveCommon",value:0,color:"#777",exact:3},
    CaveCoal:{rarity:"CaveExclusiveCommon",value:0,color:"#444",exact:10},
    CaveIron:{rarity:"CaveExclusiveUncommon",value:0,color:"#aaa",exact:20},
	Starflare:{rarity:"Exotic",value:112,color:"#ffd700",symbol:"SF",spawnMsg:"A distant star erupts as Starflare descends from the cosmos!",exact:750000, event: "space"},
	Galaxium:{rarity:"Exquisite",value:113,color:"#9c27ff",symbol:"GX",spawnMsg:"Galaxium spirals into existence, bending light itself!",exact:15000000},
	NebulonPrime:{rarity:"Transcendent",value:114,color:"#00e5ff",symbol:"NP",spawnMsg:"A celestial hum echoes as NebulonPrime forms from stellar dust!",exact:42000000, event: "space"},
	EventHorizonShard:{rarity:"Enigmatic",value:115,color:"#1a1a1a",symbol:"EH",spawnMsg:"Space distorts violently around the EventHorizonShard!",exact:88000000, event: "space"},
	SingularityCore:{rarity:"Unfathomable",value:116,color:"#000000",symbol:"SC",spawnMsg:"Gravity collapses inward as SingularityCore manifests!",exact:210000000, event: "space"},
	AstralOblivion:{rarity:"Otherworldly",value:117,color:"#311b92",symbol:"AO",spawnMsg:"The void trembles as AstralOblivion tears through reality!",exact:600000000, event: "space"},
	CosmicParallax:{rarity:"Imaginary",value:118,color:"#111111",symbol:"CP",spawnMsg:"Dimensions overlap as CosmicParallax fractures perception!",exact:1700000000, event: "space"},
	HypernovaX:{rarity:"Zenith",value:119,color:"#ff1744",symbol:"HX",spawnMsg:"A supernova detonates across time as HypernovaX is born!",exact:80000000000, event: "space"},
	VoidGenesis:{rarity:"Eternal",value:120,color:"#ffffff",symbol:"VG",spawnMsg:"Creation and annihilation intertwine as VoidGenesis awakens!",exact:8000000000000, event: "space"},
	TidalShard:{rarity:"Exotic",value:121,color:"#00bfff",symbol:"TS",spawnMsg:"Tides surge violently as TidalShard rises from the abyss!",exact:800000, event: "ocean"},
	AbyssPearl:{rarity:"Exquisite",value:122,color:"#66ccff",symbol:"AP",spawnMsg:"A deep resonance echoes as AbyssPearl surfaces from the depths!",exact:16000000, event: "ocean"},
	MaelstromCore:{rarity:"Transcendent",value:123,color:"#0077be",symbol:"MC",spawnMsg:"A vortex spirals wildly as MaelstromCore forms!",exact:43000000, event: "ocean"},
	LeviathanScale:{rarity:"Enigmatic",value:124,color:"#003366",symbol:"LS",spawnMsg:"Ancient waters churn as LeviathanScale emerges!",exact:92000000, event: "ocean"},
	OceanicRift:{rarity:"Unfathomable",value:125,color:"#002244",symbol:"OR",spawnMsg:"The seabed splits apart revealing OceanicRift!",exact:225000000, event: "ocean"},
	AbyssalCataclysm:{rarity:"Otherworldly",value:126,color:"#001133",symbol:"AC",spawnMsg:"The ocean roars as AbyssalCataclysm awakens!",exact:650000000, event: "ocean"},
	DeepSeaMirage:{rarity:"Imaginary",value:127,color:"#0d0d1a",symbol:"DM",spawnMsg:"Reality ripples beneath crushing pressure as DeepSeaMirage appears!",exact:1800000000, event: "ocean"},
	TsunamiPrime:{rarity:"Zenith",value:128,color:"#0099ff",symbol:"TP",spawnMsg:"A towering wave of power crashes forth as TsunamiPrime manifests!",exact:90000000000, event: "ocean"},
	EternalTide:{rarity:"Eternal",value:129,color:"#00ffff",symbol:"ET",spawnMsg:"The oceans pause as EternalTide commands the abyss!",exact:9000000000000, event: "ocean"},
	CinderSpark:{rarity:"Exotic",value:130,color:"#ff6600",symbol:"CS",spawnMsg:"A sudden burst of heat ignites as CinderSpark flares!",exact:820000, event: "fire"},
	Blazite:{rarity:"Exquisite",value:131,color:"#ff3300",symbol:"BZ",spawnMsg:"Flames roar fiercely as Blazite crystallizes!",exact:16500000,event: "fire"},
	InfernoShard:{rarity:"Transcendent",value:132,color:"#ff0000",symbol:"IS",spawnMsg:"Molten fury solidifies into InfernoShard!",exact:45000000, event: "fire"},
	HellfireCore:{rarity:"Enigmatic",value:133,color:"#8b0000",symbol:"HC",spawnMsg:"The ground fractures as HellfireCore erupts!",exact:98000000, event: "fire"},
	MoltenOblivion:{rarity:"Unfathomable",value:134,color:"#990000",symbol:"MO",spawnMsg:"Volcanic rage manifests as MoltenOblivion!",exact:240000000, event: "fire"},
	PhoenixEmber:{rarity:"Otherworldly",value:135,color:"#ff1744",symbol:"PE",spawnMsg:"A blazing phoenix cry echoes as PhoenixEmber ignites!",exact:700000000, event: "fire"},
	PyroMirage:{rarity:"Imaginary",value:136,color:"#1a0000",symbol:"PM",spawnMsg:"Flames distort reality itself as PyroMirage flickers!",exact:1900000000, event: "fire"},
	SolarInfernum:{rarity:"Zenith",value:137,color:"#ff5722",symbol:"SI",spawnMsg:"The sun flares violently as SolarInfernum descends!",exact:95000000000, event: "fire"},
	EternalInfernis:{rarity:"Eternal",value:138,color:"#ffcc00",symbol:"EI",spawnMsg:"An eternal flame consumes time as EternalInfernis awakens!",exact:9500000000000, event: "fire"},
	Bitcrystal:{rarity:"Exotic",value:139,color:"#00ffcc",symbol:"BC",spawnMsg:"Digital fragments assemble as Bitcrystal compiles!",exact:850000, event: "computer"},
	DataCore:{rarity:"Exquisite",value:140,color:"#33ccff",symbol:"DC",spawnMsg:"System signals spike as DataCore initializes!",exact:17000000, event: "computer"},
	GlitchShard:{rarity:"Transcendent",value:141,color:"#00ffff",symbol:"GS",spawnMsg:"Reality flickers as GlitchShard corrupts the grid!",exact:47000000, event: "computer"},
	FirewallRelic:{rarity:"Enigmatic",value:142,color:"#ff0033",symbol:"FR",spawnMsg:"A digital barrier surges as FirewallRelic activates!",exact:99000000, event: "computer"},
	QuantumKernel:{rarity:"Unfathomable",value:143,color:"#00ff66",symbol:"QK",spawnMsg:"Processing beyond comprehension begins as QuantumKernel boots!",exact:260000000, event: "computer"},
	NeuralOverdrive:{rarity:"Otherworldly",value:144,color:"#0033ff",symbol:"NO",spawnMsg:"AI consciousness spikes as NeuralOverdrive evolves!",exact:720000000, event: "computer"},
	SimulatedVoid:{rarity:"Imaginary",value:145,color:"#000000",symbol:"SV",spawnMsg:"The simulation fractures revealing SimulatedVoid!",exact:2000000000, event: "computer"},
	OmegaProtocol:{rarity:"Zenith",value:146,color:"#cccccc",symbol:"OP",spawnMsg:"System override complete. OmegaProtocol engaged.",exact:100000000000, event: "computer"},
	EternalAlgorithm:{rarity:"Eternal",value:147,color:"#ffffff",symbol:"EA",spawnMsg:"The final equation resolves as EternalAlgorithm executes infinitely!",exact:10000000000000, event: "computer"},
	Radionite:{rarity:"Exotic",value:148,color:"#7fff00",symbol:"RN",spawnMsg:"A faint radioactive glow intensifies as Radionite stabilizes!",exact:900000, event: "nuclear"},
	Uranex:{rarity:"Exquisite",value:149,color:"#66ff33",symbol:"UX",spawnMsg:"Energy pulses violently as Uranex begins to decay!",exact:18000000, event: "nuclear"},
	PlutonShard:{rarity:"Transcendent",value:150,color:"#33cc33",symbol:"PS",spawnMsg:"Unstable atoms collide as PlutonShard crystallizes!",exact:50000000, event: "nuclear"},
	ReactorCoreX:{rarity:"Enigmatic",value:151,color:"#228b22",symbol:"RC",spawnMsg:"Containment fails momentarily as ReactorCoreX materializes!",exact:110000000, event: "nuclear"},
	AtomicCataclysm:{rarity:"Unfathomable",value:152,color:"#00aa00",symbol:"AC",spawnMsg:"A chain reaction surges as AtomicCataclysm forms!",exact:280000000, event: "nuclear"},
	FusionOblivion:{rarity:"Otherworldly",value:153,color:"#00ff00",symbol:"FO",spawnMsg:"Fusion ignites beyond control as FusionOblivion emerges!",exact:800000000, event: "nuclear"},
	GammaSingularity:{rarity:"Imaginary",value:154,color:"#003300",symbol:"GS",spawnMsg:"Gamma radiation distorts space as GammaSingularity appears!",exact:2200000000, event: "nuclear"},
	MeltdownPrime:{rarity:"Zenith",value:155,color:"#adff2f",symbol:"MP",spawnMsg:"A catastrophic surge erupts as MeltdownPrime destabilizes reality!",exact:120000000000, event: "nuclear"},
	EternalFission:{rarity:"Eternal",value:156,color:"#ccff00",symbol:"EF",spawnMsg:"Infinite fission fractures existence as EternalFission awakens!",exact:11000000000000, event: "nuclear"},
	Evolite:{rarity:"Exotic",value:157,color:"#cfa26b",symbol:"EV",spawnMsg:"A soft evolutionary aura surrounds Evolite!",exact:950000, event: "evolie"},
	Vaporeore:{rarity:"Exquisite",value:158,color:"#3399ff",symbol:"VP",spawnMsg:"Water ripples outward as Vaporeore flows into form!",exact:19000000, event: "evolie"},
	Jolteonite:{rarity:"Transcendent",value:159,color:"#ffff33",symbol:"JL",spawnMsg:"Electric sparks scatter as Jolteonite discharges violently!",exact:52000000, event: "evolie"},
	Flareonyx:{rarity:"Enigmatic",value:160,color:"#ff6600",symbol:"FL",spawnMsg:"Flames spiral upward as Flareonyx ignites the air!",exact:115000000, event: "evolie"},
	Espeorite:{rarity:"Unfathomable",value:161,color:"#cc66ff",symbol:"ES",spawnMsg:"Psychic waves distort perception as Espeorite materializes!",exact:300000000, event: "evolie"},
	Umbreonite:{rarity:"Otherworldly",value:162,color:"#111133",symbol:"UM",spawnMsg:"Shadows gather silently as Umbreonite reveals itself!",exact:850000000, event: "evolie"},
	Leafeostone:{rarity:"Imaginary",value:163,color:"#66cc66",symbol:"LF",spawnMsg:"Nature's energy blossoms as Leafeostone grows instantly!",exact:2400000000, event: "evolie"},
	Glaceorite:{rarity:"Zenith",value:164,color:"#99ffff",symbol:"GL",spawnMsg:"Absolute zero descends as Glaceorite freezes time itself!",exact:130000000000, event: "evolie"},
	EternalEvolux:{rarity:"Eternal",value:165,color:"#ffffff",symbol:"EX",spawnMsg:"All evolutionary paths converge as EternalEvolux transcends existence!",exact:12000000000000, event: "evolie"},
};
const oreImages = {};
for (let ore in oreData) {
    if (oreData[ore].imgSrc) {
        const img = new Image();
        img.src = oreData[ore].imgSrc; // Path relative to your HTML/game folder
        oreImages[ore] = img;
    }
}

const rarityColors = {
    "IceCaveExclusive-Exotic": "#ffeb3b",
    "EnergyCaveExclusive-Exquisite": "#00ff00",
    "EnergyCaveExclusive-Zenith": "#DF03FC",
    "NuclearCaveExclusive-Transcendent": "#2196f3",
    "ShadowCaveExclusive-Enigmatic": "#fff176",
    "ShadowCaveExclusive-Imaginary": "#ffffe0",
    "AbyssCaveExclusive-Unfathomable": "#0d47a1",
    "AbyssCaveExclusive-Zenith": "#DF03FC",
    "CaveExclusive-Mythical": "#DF03FC",
    "CaveExclusive-Eternal": "#00FBFF",
    Exotic: "#ffeb3b",
    Exquisite: "#00ff00",
    Transcendent: "#2196f3",
    Enigmatic: "#fff176",
    Unfathomable: "#0d47a1",
    Otherworldly: "#8b0000",
    Imaginary: "#ffffe0",
    Divine: "#ff0000",
    Zenith: "#DF03FC",
    Eternal: "#00FBFF",
    SPAFF: "#ff9900"
};

const rarityOrder = ["Common","Uncommon","Rare","Epic","Legendary","Legendary+",
                     "Mythic","Exotic","Divine","Exquisite","Transcendent","Enigmatic",
                     "Unfathomable","Otherworldly","Imaginary","Zenith","Eternal","SPAFF"];

// Pickaxes
const pickaxeData = {
    T0:{desc:"Starter pickaxe, mines 1 block.", cost:{}},
    T1:{desc:"25% chance to mine an adjacent block.", cost:{Stone:50, Coal:25}},
    T2:{desc:"Mines 2 blocks horizontally.", cost:{Iron:30, Emerald:10}},
    T3:{desc:"Mines in a cross shape.", cost:{Iron:50, Ruby:15, Emerald:10}},
    T4:{desc:"do a 3x3 explosion.", cost:{Ruby:20, Sapphire:10, Emerald:5}},
    T5:{desc:"5-layer 3x3 mine. 50% chance to spawn a new 50K+ ore when mined.", cost:{Ruby:50, Sapphire:25, Topaz:20, Diamond:5, Void:3, Gold:1}},
	T6:{desc: "7-layer 3x3 mine. 75% chance to spawn a new 10K+ ore, 25% chance to upgrade a random block. Gives 5x luck boost.", cost: {Tera: 1, TeraPlus: 1, Smiley: 5}},
	T7:{desc: "5-layer 3x3 mine. Gives 25x luck boost.",cost: { NovaShard: 5, Lunarium: 2, FrostWraith: 10 }},
	T8:{desc: "5-layer 3x3 mine. Gives 50x luck boost.",cost: { ShadowFragment: 2, NightCore: 5, AbyssGem: 1 }},
	T9:{desc: "Mines 5 layers in 3x3. Gives 75√ó luck multiplier. Every 5M blocks mined, guarantees a 50M+ ore spawn.",cost: { ShadowFragment: 5, PhantomCrystal: 5, AbyssGem: 2, ZergHunter: 1 }},
	T10: {desc: " Final Pickaxe 100√ó Luck. Mines 5 layers in 3x3. Every 4,000,000 blocks mined guarantees at a Unfathomable ore to spawn.",cost: { Stone: 50000000, AlterDemon: 100, TeraPlus: 250, Solarium: 25, Ecliptium: 50, PetaPlus4: 44, VoidPlus: 2, CosmicRelic: 1 }},
};

// Gear
const gearData = {
    T1:{desc:"Chance to explode 3x3 area.",cost:{Iron:25, Coal:20}},
    T2:{desc:"+5% chance to duplicate ore.",cost:{Iron:30, Coal:15}},
    T3:{desc:"25% chance for 3x ore, 50% chance for 2x ore.",cost:{Emerald:10, Iron:50}},
    T4:{desc:"Give  +2 Luck boost",cost:{Ruby:5, Emerald:10}},
    T5:{desc:"Give +10 Luck boost and as a 50% to dupliate ore 2x 25% 3x and 25% for 5x",cost:{Emerald:5, Ruby:5, Sapphire:1, Void:1, Giga:1}},
	T6:{ desc: "Give +25 Luck boost and 5% to upgrade a mined ore by 1 tier",cost: {Peta:1, Tera:1, AlterDemon:2}},
	T7:{desc: "Give +35 Luck and increases high-tier ore spawn chance by 1% per mined block (stacks to 500%). Resets on 10M+ ore drop.",cost: {Hyperion:1, TwilightGem:1, Astralite:5, EmberPhantom:10},highTierStack: 0, maxStack: 500},
	T8:{desc: "+50 Luck bonus. 1% chance to multiply mined ores <100K by 100√ó", cost: { Stone: 10000000, Iron: 2000000, OblivionCore: 1 }},
	T9:{desc: "+75 Luck bonus. 20% chance to upgrade a mined ore by 1 rarity tier",cost: {Quantumite: 20,FrostWraith: 100,FrostShard: 2}},
	T10: {desc: "Final Gear +100 Luck. When mining a 50M+ ore: 50% chance to respawn it and another independent 50% chance to upgrade it with no cap.",cost: { Zanacharium: 1,AbyssalSingularity: 2,ZergHunter: 50}},
};

// Artefacts
const artefactData = {
    1:{desc:"Mines 1 block every 5s",cost:{Stone:10},interval:5000,blocks:1},
    2:{desc:"Mines 2 block every 4s",cost:{Coal:10},interval:4000,blocks:2},
    3:{desc:"Mines 3 block every 1s",cost:{Emerald:25},interval:1000,blocks:3},
    4:{desc:"Mines 5 blocks every 1s",cost:{Void:20},interval:1000,blocks:5},
    5:{desc:"Mines 25 blocks every 1s",cost:{HyperMega:1},interval:1000,blocks:25},
	6:{desc:"Mines 30 blocks every 1s",cost:{Tera:1},interval:1000,blocks:30},
	7:{desc:"Mines 40 blocks every 1s",cost:{TeraPlus:1},interval:1000,blocks:40},
	8:{desc:"Mines 50 blocks every 1s",cost:{PetaPlus1:1},interval:1000,blocks:50},
	9:{desc:"Mines 60 blocks every 1s",cost:{Celestium:1},interval:1000,blocks:60},
	10:{desc:"Mines 80 blocks every 1s",cost:{Nebulium:1},interval:1000,blocks:80},
};

// Luck Artefacts for levels 1‚Äì50
const luckArtefactData = {};
for (let lvl = 1; lvl <= 50; lvl++) {
    luckArtefactData[lvl] = { 
        desc: `+${lvl*10}% luck for ores ‚â• 1K`, 
        cost: { Emerald: 10*lvl } 
    };
}

// Define extra luck levels past 50
const extraLuckLevels = {
    51: { desc: "+600% luck for ores ‚â• 1K", cost: { SoulGlacier: 50 } },
    52: { desc: "+750% luck for ores ‚â• 1K", cost: { PetaPlus1: 60 } },
    53: { desc: "+1000% luck for ores ‚â• 1K", cost: { Astralite: 50, Vortexium: 10 } },
    54: { desc: "+1500% luck for ores ‚â• 1K", cost: { EclipseShard: 15 } },
    55: { desc: "+2000% luck for ores ‚â• 1K", cost: { AbyssGem: 20 } },
    56: { desc: "+3000% luck for ores ‚â• 1K", cost: { FrostShard: 3 } },
    57: { desc: "+4000% luck for ores ‚â• 1K", cost: { Voidessence: 2 } },
    58: { desc: "+5000% luck for ores ‚â• 1K", cost: { CosmicRelic: 2, Infinity: 1 } },
    59: { desc: "+7500% luck for ores ‚â• 1K", cost: { Aetherion: 1 } },
    60: { desc: "+10000% luck for ores ‚â• 1K", cost: { GenesisFragment: 1 } },
};

// Merge the extra levels into the main luckArtefactData
Object.assign(luckArtefactData, extraLuckLevels);


// Grid
function generateGrid(){
    grid = [];
    for(let y=0;y<GRID;y++){
        let row=[];
        for(let x=0;x<GRID;x++){
            row.push(randomOre());
        }
        grid.push(row);
    }
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.font = "40px Arial";

    for (let y = 0; y < GRID; y++) {
        for (let x = 0; x < GRID; x++) {
            let ore = grid[y][x];
            const data = oreData[ore];

            // If there‚Äôs an image for the ore, draw it
            if (oreImages[ore]) {
                ctx.drawImage(oreImages[ore], x * SIZE, y * SIZE, SIZE - 2, SIZE - 2);
            } else {
                ctx.fillStyle = data.color;
                ctx.fillRect(x * SIZE, y * SIZE, SIZE - 2, SIZE - 2);
                if (data.symbol) {
                    ctx.fillStyle = data.symbolColor || "#fff";
                    ctx.fillText(data.symbol, x * SIZE + SIZE / 2, y * SIZE + SIZE / 2);
                }
            }
        }
    }
}


function getValidOres(ores) {
    return ores.filter(ore => {
        const event = oreData[ore].event;
        return !event || event === currentEvent;
    });
}

function randomOre() {
    if (activeCave) {
        if (blocksMined >= caveEndAt) {
            activeCave = null;
            updateCaveUI();
            console.log("The cave has collapsed.");
            return "Stone";
        }

        if (!activeCave.startTime) activeCave.startTime = Date.now();
        const elapsed = (Date.now() - activeCave.startTime) / 1000;

        // Filter exclusive ores by event
        const validExclusiveOres = getValidOres(activeCave.exclusiveOres);

        if (elapsed >= 2 && validExclusiveOres.length > 0) {
            for (const ore of validExclusiveOres) {
                if (Math.random() < 1 / oreData[ore].exact) {
                    if (oreData[ore].spawnMsg) setTimeout(() => tryPlaySpawnSound(ore), 50);
                    return ore;
                }
            }
        }

        const validCaveBlocks = getValidOres(activeCave.caveBlocks);
        if (validCaveBlocks.length > 0) {
            return validCaveBlocks[Math.floor(Math.random() * validCaveBlocks.length)];
        }

        return "Stone";
    }

    // ===== Normal World =====
    let allOres = Object.keys(oreData).filter(
        ore => !oreData[ore].rarity.includes("CaveExclusive")
    );

    const availableOres = getValidOres(allOres);

    if (!availableOres.length) return "Stone";

    // Weighted random (luck included)
    const weights = availableOres.map(ore => {
        const data = oreData[ore];
        let baseChance = 1 / data.exact;

        if (luckArtefactLevel > 0 && data.exact >= 1000) {
            const maxLevel = 60;
            const maxMultiplier = 10;
            const scaleFactor =
                1 + (Math.log10(luckArtefactLevel + 1) / Math.log10(maxLevel + 1)) * (maxMultiplier - 1);
            baseChance *= scaleFactor;
        }

        return baseChance;
    });

    const totalWeight = weights.reduce((sum, w) => sum + w, 0);
    let random = Math.random() * totalWeight;

    for (let i = 0; i < availableOres.length; i++) {
        random -= weights[i];
        if (random <= 0) {
            const selectedOre = availableOres[i];
            if (oreData[selectedOre].exact >= 250000 && oreData[selectedOre].spawnMsg) {
                setTimeout(() => tryPlaySpawnSound(selectedOre), 50);
            }
            return selectedOre;
        }
    }

    return "Stone";
}
function randomHighTierOre() {
    const ores = Object.keys(oreData).filter(o => oreData[o].exact >= 50000);

    for (let i = ores.length - 1; i >= 0; i--) {
        const ore = ores[i];

        let chance = 1 / (oreData[ore].exact * 50);

        // Apply T7 additive bonus
        if (equippedGears.includes("T7") && gearData.T7) {
            chance += gearData.T7.highTierStack / 10000; 
            // highTierStack max 500 ‚Üí max 0.05 = +5% additive chance
        }

        if (Math.random() < chance) {
            if (oreData[ore].exact >= 250000 && oreData[ore].spawnMsg) {
                setTimeout(() => tryPlaySpawnSound(ore), 50);
            }
            return ore;
        }
    }

    return ores[0];
}


// Mining
canvas.addEventListener("click",e=>{
    let rect=canvas.getBoundingClientRect();
    let x=Math.floor((e.clientX-rect.left)/SIZE);
    let y=Math.floor((e.clientY-rect.top)/SIZE);
    mineBlocks(x,y,true);
});

let lastT6Upgrade = 0; // global variable to track T6 30s cooldown
let t9MinedCounter = 0;
let t10MinedCounter = 0;

function mineBlocks(x, y, manual = false) {
    if (spawnLock) return;
    if (!grid[y] || !grid[y][x]) return;

    let targets = [[x, y]];

    let explosionChance = 0, tripleChance = 0, doubleChance = 0, luckMultiplier = 1;

    // Pickaxe mining patterns
    switch (equippedPickaxe) {
        case "T1":
            if (Math.random() < 0.25) {
                const dirs = [[1,0],[-1,0],[0,1],[0,-1]];
                const [dx, dy] = dirs[Math.floor(Math.random()*dirs.length)];
                targets.push([x+dx, y+dy]);
            }
            break;
        case "T2": targets = [[x,y],[x+1,y],[x-1,y]]; break;
        case "T3": targets = [[x,y],[x+1,y],[x-1,y],[x,y+1],[x,y-1]]; break;
        case "T4":
            for (let dx=-1; dx<=1; dx++)
                for (let dy=-1; dy<=1; dy++)
                    targets.push([x+dx, y+dy]);
            explosionChance += 0.1; break;
        case "T5":
            for (let layer=0; layer<5; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy]);
            explosionChance += 0.5; break;
        case "T6":
            for (let layer=0; layer<7; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy+layer]);
            luckMultiplier *= 5; break;
        case "T7":
            for (let layer=0; layer<5; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy+layer]);
            luckMultiplier *= 35; break;
        case "T8":
            for (let layer=0; layer<5; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy+layer]);
            luckMultiplier *= 50; break;
        case "T9":
            for (let layer=0; layer<5; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy+layer]);
            luckMultiplier *= 75; break;
        case "T10":
            for (let layer=0; layer<5; layer++)
                for (let dx=-1; dx<=1; dx++)
                    for (let dy=-1; dy<=1; dy++)
                        targets.push([x+dx, y+dy+layer]);
            luckMultiplier *= 100; break;
    }

    // Apply gear bonuses
    equippedGears.forEach(g => {
        switch(g) {
            case "T1": explosionChance += 0.1; break;
            case "T3": tripleChance += 0.25; doubleChance += 0.5; break;
            case "T4": luckMultiplier += 2; break;
            case "T5": luckMultiplier += 10; break;
            case "T6": luckMultiplier += 25; break;
            case "T7":
                luckMultiplier += 35;
                if (!gearData.T7) gearData.T7 = {};
                gearData.T7.highTierStack = (gearData.T7.highTierStack || 0) + 1;
                break;
            case "T9": luckMultiplier += 75; break;
            case "T10": luckMultiplier += 100; break;
        }
    });

    let t9UpgradeApplied = false;

    targets.forEach(([tx, ty]) => {
        if (tx < 0 || ty < 0 || ty >= GRID || tx >= GRID) return;

        let ore2 = grid[ty][tx];
        let data2 = oreData[ore2];
        let count = 1;

        // Increment mined blocks & check cave spawn
        blocksMined++;
        checkForCaveSpawn();

if (activeCave && activeCave.caveBlocks.includes(ore2)) {
    const exclusiveOres = activeCave.exclusiveOres;
    let chosenOre = null;

    // Try each exclusive ore independently
    for (const ore of exclusiveOres) {
        if (Math.random() < 1 / oreData[ore].exact) {
            chosenOre = ore;
            break;
        }
    }

    // Fallback: if no rare ore, pick a common cave block
    if (!chosenOre) {
        chosenOre = activeCave.caveBlocks[
            Math.floor(Math.random() * activeCave.caveBlocks.length)
        ];
    }

    // Give ore to inventory immediately
    inventory[chosenOre] = (inventory[chosenOre] || 0) + 1;
    updateRecentFind(chosenOre, 1);

    // Replace the grid block with a normal cave block
    grid[ty][tx] = activeCave.caveBlocks[
        Math.floor(Math.random() * activeCave.caveBlocks.length)
    ];

    return; // skip normal ore logic
}






        /* =========================
           NORMAL WORLD ORES: apply luck, duplication, upgrades
        ========================== */
        // T9 passive counter
        if (equippedPickaxe === "T9") {
            t9MinedCounter++;
            if (t9MinedCounter >= 5000000) {
                t9MinedCounter = 0;
                const rare50M = Object.keys(oreData).filter(o => oreData[o].exact >= 50000000);
                if (rare50M.length > 0) {
                    const rx = Math.floor(Math.random()*GRID);
                    const ry = Math.floor(Math.random()*GRID);
                    const chosen = rare50M[Math.floor(Math.random()*rare50M.length)];
                    grid[ry][rx] = chosen;
                    if (oreData[chosen].spawnMsg) setTimeout(() => tryPlaySpawnSound(chosen), 50);
                    console.log("T9 Passive Activated: 50M+ Ore Spawned!");
                }
            }
        }

        // T10 passive counter
        if (equippedPickaxe === "T10") {
            t10MinedCounter++;
            if (t10MinedCounter >= 4000000) {
                t10MinedCounter = 0;
                const uOres = Object.keys(oreData).filter(o => oreData[o].rarity === "Unfathomable");
                if (uOres.length) {
                    const ux = Math.floor(Math.random()*GRID);
                    const uy = Math.floor(Math.random()*GRID);
                    const chosen = uOres[Math.floor(Math.random()*uOres.length)];
                    grid[uy][ux] = chosen;
                    if (oreData[chosen].spawnMsg) setTimeout(() => tryPlaySpawnSound(chosen),50);
                    console.log("T10 Passive Activated: Unfathomable Spawned!");
                }
            }
        }

        // Duplication and triple/double chances
        if (equippedGears.includes("T2") && Math.random() < 0.05) count++;
        if (equippedGears.includes("T3") && Math.random() < 0.25) count *= 2;
        if (Math.random() < tripleChance) count *= 3;
        else if (Math.random() < doubleChance) count *= 2;

        // Inline upgrades for normal ores
        if (equippedGears.includes("T6") && Math.random() < 0.05) {
            const idx = rarityOrder.indexOf(data2.rarity);
            if (idx >= 0 && idx < rarityOrder.length - 1) {
                const next = rarityOrder[idx + 1];
                const candidates = Object.keys(oreData).filter(o => oreData[o].rarity === next);
                if (candidates.length > 0) ore2 = candidates[Math.floor(Math.random()*candidates.length)];
            }
        }

        if (!t9UpgradeApplied && equippedGears.includes("T9") && Math.random() < 0.2) {
            const idx = rarityOrder.indexOf(data2.rarity);
            if (idx >= 0 && idx < rarityOrder.length - 1) {
                const next = rarityOrder[idx + 1];
                const candidates = Object.keys(oreData).filter(o => oreData[o].rarity === next);
                if (candidates.length > 0) ore2 = candidates[Math.floor(Math.random()*candidates.length)];
            }
            t9UpgradeApplied = true;
        }

        if (equippedGears.includes("T10") && data2.exact >= 50000000) {
            if (Math.random() < 0.5) {
                const idx = rarityOrder.indexOf(data2.rarity);
                if (idx >= 0 && idx < rarityOrder.length - 1) {
                    const next = rarityOrder[idx + 1];
                    const candidates = Object.keys(oreData).filter(o => oreData[o].rarity === next);
                    if (candidates.length > 0) ore2 = candidates[Math.floor(Math.random()*candidates.length)];
                    console.log("T10 Gear: 50M+ Ore Upgraded!");
                }
            }
            if (Math.random() < 0.5) grid[ty][tx] = ore2;
            else grid[ty][tx] = randomOre();
        } else {
            grid[ty][tx] = randomOre();
        }

        // Add normal ore to inventory
        inventory[ore2] = (inventory[ore2] || 0) + count;
        updateRecentFind(ore2, count);
    });

    updateCounters();
    updateUI();
    draw();
}



	function updateCounters() {
    totalBlocksMined = 0;
    globalBlocksMined = 0;

    for (let ore in inventory) {
        const count = inventory[ore] || 0;
		totalBlocksMined += count;
		if (oreData[ore].exact >= 100000000) globalBlocksMined += count;
    }

    document.getElementById("totalMined").innerText = `Total Mined: ${formatNumber(totalBlocksMined)}`;
    document.getElementById("globalMined").innerText = `Global Mined: ${formatNumber(globalBlocksMined)}`;
}


// Auto-Miner
function startArtefact(){
    if(artefactInterval) clearInterval(artefactInterval);
    if(artefactLevel===0) return;
    let a=artefactData[artefactLevel];
    artefactInterval=setInterval(()=>{
        for(let i=0;i<a.blocks;i++) mineBlocks(1,1,false);
    },a.interval);
}
// UI Helpers
function costToString(cost) {
    return Object.entries(cost).map(([o, a]) => `${a} ${o}`).join(", ");
}
function canAfford(cost) {
    for (let o in cost) if ((inventory[o] || 0) < cost[o]) return false;
    return true;
}
function spendCost(cost) {
    for (let o in cost) inventory[o] -= cost[o];
}

	function updateUI() {
    const invDiv = document.getElementById("inventory");
    invDiv.innerHTML = "";

    Object.keys(inventory)
        .sort((a, b) => sortRarestFirst ? oreData[b].exact - oreData[a].exact : oreData[a].exact - oreData[b].exact)
        .forEach(o => {
            const r = oreData[o];
            const count = inventory[o] || 0;

            const div = document.createElement("div");
            div.style.cursor = "pointer";
            div.style.background = r.color;
            div.style.color = r.symbolColor || "#fff";
            div.style.border = "2px solid #000";
            div.style.padding = "2px";
            div.style.marginBottom = "2px";
            div.innerHTML = `${o} (${r.rarity}) - ${formatNumber(count)}`;
            
            // Click to show ore viewer
            div.onclick = () => showOreViewer(o);

            invDiv.appendChild(div);
        });

    // Pickaxes, Gears, Artefacts, Luck Artefacts
    const pUI = document.getElementById("pickaxeUI");
    pUI.innerHTML = "";
    for (let name in pickaxeData) createPickaxeButton(name, pickaxeData[name].desc, pickaxeData[name].cost);

    const gUI = document.getElementById("gearUI");
    gUI.innerHTML = "";
    for (let name in gearData) createGearButton(name, gearData[name].desc, gearData[name].cost);

    updateArtefactUI();
    updateLuckArtefactUI();
    updateOreIndex();
}




	function updateOreIndex() {
    const indexDiv = document.getElementById("oreIndex");
    const allOres = Object.keys(oreData);

    // Count how many ores you actually own (>0)
    const discoveredOres = allOres.filter(ore => (inventory[ore] || 0) > 0).length;

    indexDiv.innerHTML = `<h3>Ore Index (${discoveredOres} / ${allOres.length})</h3>`;

    allOres
        .sort((a, b) => sortRarestFirst ? oreData[b].exact - oreData[a].exact : oreData[a].exact - oreData[b].exact)
        .forEach(ore => {
            const r = oreData[ore];
            const owned = (inventory[ore] || 0) > 0; // ‚úÖ fixed

            const div = document.createElement("div");
            div.style.color = owned ? "lime" : "red"; // green if owned, red if not
            div.style.fontSize = "13px";
            div.style.padding = "2px 4px";
            div.style.marginBottom = "1px";
            div.style.cursor = "pointer";

            div.innerHTML = `${ore} (${r.rarity}) - 1 in ${formatNumber(r.exact)}`;
            indexDiv.appendChild(div);
        });
}


// PICKAXE BUTTON
function createPickaxeButton(name, desc, cost) {
    const container = document.createElement("div");
    container.style.marginBottom = "6px";

    const owned = ownedPickaxes.includes(name);
    const eq = (equippedPickaxe === name);

    const btn = document.createElement("button");
    btn.innerText = owned ? name + (eq ? " (Equipped)" : " (Owned)") : "Buy " + name;

    btn.onclick = owned
        ? () => { equippedPickaxe = name; updateUI(); }
        : () => {
            if (canAfford(cost)) {
                spendCost(cost);
                ownedPickaxes.push(name);
                updateUI();
            } else alert("Not enough resources");
        };

    container.appendChild(btn);

    const div = document.createElement("div");
    div.style.fontSize = "12px";

    if (!owned) {
        div.innerHTML = desc + "<br><strong>Cost:</strong> " + costToString(cost);
        if (canAfford(cost)) div.style.color = "lime"; // GREEN if affordable
    } else {
        div.innerHTML = desc;
    }

    container.appendChild(div);
    document.getElementById("pickaxeUI").appendChild(container);
}

// GEAR BUTTON
function createGearButton(name, desc, cost) {
    const container = document.createElement("div");
    container.style.marginBottom = "6px";

    const owned = ownedGears.includes(name);
    const eq = equippedGears.includes(name);

    const btn = document.createElement("button");
    btn.innerText = owned ? name + (eq ? " (Equipped)" : " (Owned)") : "Buy " + name;

    btn.onclick = owned
        ? () => equipGear(name)
        : () => {
            if (canAfford(cost)) {
                spendCost(cost);
                ownedGears.push(name);
                updateUI();
            } else alert("Not enough resources");
        };

    container.appendChild(btn);

    const div = document.createElement("div");
    div.style.fontSize = "12px";

    if (!owned) {
        div.innerHTML = desc + "<br><strong>Cost:</strong> " + costToString(cost);
        if (canAfford(cost)) div.style.color = "lime"; // GREEN if affordable
    } else {
        div.innerHTML = desc;
    }

    container.appendChild(div);
    document.getElementById("gearUI").appendChild(container);
}

// Equip Gear
function equipGear(name) {
    if (!equippedGears.includes(name)) {
        if (equippedGears.length >= 2) equippedGears.shift();
        equippedGears.push(name);
    } else equippedGears = equippedGears.filter(g => g !== name);
    updateUI();
}

	// ARTEFACT UI
function updateArtefactUI() {
    const aUI = document.getElementById("artefactUI");
    aUI.innerHTML = "";

    const maxLevel = Object.keys(artefactData).length;

    for (let lvl = 1; lvl <= maxLevel; lvl++) {
        const container = document.createElement("div");
        container.style.marginBottom = "6px";

        const a = artefactData[lvl];
        const btn = document.createElement("button");

        if (lvl < artefactLevel) {
            // Already purchased but NOT equipped
            btn.innerText = `Level ${lvl} (Unlocked)`;
            btn.disabled = true;
        } else if (lvl === artefactLevel) {
            // Currently equipped
            btn.innerText = `Level ${lvl} (Equipped)`;
            btn.disabled = true;
        } else if (lvl === artefactLevel + 1) {
            // Next level available to buy
            btn.innerText = `Buy Level ${lvl}`;
            btn.onclick = () => {
                if (canAfford(a.cost)) {
                    spendCost(a.cost);

                    // Update level
                    artefactLevel = lvl;

                    // Auto-equip new level
                    if (artefactInterval) clearInterval(artefactInterval);
                    startArtefact();

                    // Update UI to show new level equipped
                    updateUI();
                } else {
                    alert("Not enough resources");
                }
            };
        } else {
            // Future locked levels
            btn.innerText = `Locked`;
            btn.disabled = true;
        }

        container.appendChild(btn);

        const div = document.createElement("div");
        div.style.fontSize = "12px";

        if (lvl === artefactLevel + 1) {
            div.innerHTML = a.desc + "<br><strong>Cost:</strong> " + costToString(a.cost);
            if (canAfford(a.cost)) div.style.color = "lime"; // show green if affordable
        } else {
            div.innerHTML = a.desc;
        }

        container.appendChild(div);
        aUI.appendChild(container);
    }
}




function updateLuckArtefactUI() {
    const lUI = document.getElementById("luckArtefactUI");
    lUI.innerHTML = "";

    const maxLevel = Object.keys(luckArtefactData).length;

    for (let lvl = 1; lvl <= maxLevel; lvl++) {
        const container = document.createElement("div");
        container.style.marginBottom = "6px";

        const data = luckArtefactData[lvl];
        const btn = document.createElement("button");

        if (lvl < luckArtefactLevel) {
            // Already purchased but NOT equipped
            btn.innerText = `Level ${lvl} (Unlocked)`;
            btn.disabled = true;
        } else if (lvl === luckArtefactLevel) {
            // Currently equipped
            btn.innerText = `Level ${lvl} (Equipped)`;
            btn.disabled = true;
        } else if (lvl === luckArtefactLevel + 1) {
            // Next level available to buy
            btn.innerText = `Buy Level ${lvl}`;
            btn.onclick = () => {
                if (canAfford(data.cost)) {
                    spendCost(data.cost);

                    // Update level and auto-equip
                    luckArtefactLevel = lvl;

                    updateUI();
                } else {
                    alert("Not enough resources");
                }
            };
        } else {
            // Locked future levels
            btn.innerText = `Locked`;
            btn.disabled = true;
        }

        container.appendChild(btn);

        const div = document.createElement("div");
        div.style.fontSize = "12px";

        if (lvl === luckArtefactLevel + 1) {
            div.innerHTML = data.desc + "<br><strong>Cost:</strong> " + costToString(data.cost);
            if (canAfford(data.cost)) div.style.color = "lime";
        } else {
            div.innerHTML = data.desc;
        }

        container.appendChild(div);
        lUI.appendChild(container);
    }
}




// Ore Viewer
const oreViewer = document.getElementById("oreViewer");
const oreBlock = document.getElementById("oreBlock");
const oreName = document.getElementById("oreName");
const oreRarity = document.getElementById("oreRarity");

let lastSpawnOre = null;

function showOreViewer(ore) {
    const data = oreData[ore];
    oreViewer.style.display = "block";

    // Clear previous content
    oreBlock.innerHTML = "";

    // If ore has an image, show it
    if (oreImages[ore]) {
        const img = oreImages[ore].cloneNode(); // clone to allow multiple views
        img.style.width = "100%";
        img.style.height = "100%";
        img.style.objectFit = "contain";
        oreBlock.appendChild(img);
    } else {
        // Fallback: show symbol
        oreBlock.innerText = data.symbol || "";
        oreBlock.style.color = data.symbolColor || "#fff";
        oreBlock.style.background = data.color;
    }

    oreName.innerText = `${ore} (${data.rarity})`;
    oreRarity.innerText = `1 in ${formatNumber(data.exact)}`;

    // Toggle hide if same ore clicked
    if (lastSpawnOre === ore) {
        oreViewer.style.display = "none";
        lastSpawnOre = null;
    } else {
        lastSpawnOre = ore;
    }
}




// Replay button
replaySpawn.onclick = () => {
    if (lastSpawnOre) playSpawnSound(lastSpawnOre);
};



function saveGame(showAlert = true) {
    localStorage.setItem("MiningRNGSimulator", JSON.stringify({
        inventory,
        ownedPickaxes,
        equippedPickaxe,
        ownedGears,
        equippedGears,
        artefactLevel,
        luckArtefactLevel,
        pauseOnChill,
        waitingForManualHighOre
    }));

    if (showAlert) {
        alert("Game saved!");
    } else {
        console.log("Game auto-saved at " + new Date().toLocaleTimeString());
    }
}

function loadGame() {
    const save = localStorage.getItem("MiningRNGSimulator");
    if (save) {
        const data = JSON.parse(save);
        inventory = data.inventory || {};
        ownedPickaxes = data.ownedPickaxes || ["T0"];
        equippedPickaxe = data.equippedPickaxe || "T0";
        ownedGears = data.ownedGears || [];
        equippedGears = data.equippedGears || [];
        artefactLevel = data.artefactLevel || 0;
        luckArtefactLevel = data.luckArtefactLevel || 0;
        pauseOnChill = data.pauseOnChill || false;
        waitingForManualHighOre = data.waitingForManualHighOre || false;
        currentVolumeIndex = data.currentVolumeIndex ?? 0;
		setInterval(updateCaveUI, 1000); // updates once per second

    } else {
        inventory = {};
        currentVolumeIndex = 0;
    }
}
loadGame();
document.querySelectorAll("audio").forEach(a => {
    a.volume = volumeLevels[currentVolumeIndex];
});
generateGrid();
updateUI();
draw();
startArtefact();
setInterval(() => {
    saveGame(false); // false = do NOT show alert
}, 300000); // 300000ms = 5 minutes
startEventSystem();
</script>
</body>
</html>